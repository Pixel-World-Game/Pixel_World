<!DOCTYPE html><html lang="en" class="no-js">
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<script type="text/javascript" src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" charset="UTF-8" data-domain-script="6e91be4c-3145-4ea2-aa64-89d716064836" data-dLayer-ignore="true" data-document-language="true"></script><script type="text/javascript">function OptanonWrapper() {}</script><script>window.dataLayer = window.dataLayer || []; dataLayer.push({ event: 'dataLayer-initialized', user: { user_unity_id: undefined, user_logged_in: 'no' }, environment: { environment_locale: 'en-us', environment_currency: undefined }});</script><script>var offline=(location.href.indexOf('docs.unity3d.com')==-1)?true:false;if(!offline){(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=   'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);  })(window,document,'script','dataLayer','GTM-5V25JL6');}</script><link href="https://fonts.googleapis.com/css?family=Roboto&amp;display=swap" rel="stylesheet">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Unity - Manual: DOTS Instancing shaders</title>
<meta property="og:image" content="https://unity3d.com/files/images/ogimg.jpg">
<meta name="author" content="Unity Technologies">
<link rel="shortcut icon" href="https://unity.com/themes/contrib/unity_base/images/favicons/favicon.ico">
<link rel="icon" type="image/png" href="../StaticFilesManual/images/favicons/favicon.png">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="../StaticFilesManual/images/favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../StaticFilesManual/images/favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="../StaticFilesManual/images/favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../StaticFilesManual/images/favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="../StaticFilesManual/images/favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon-precomposed" href="../StaticFilesManual/images/favicons/apple-touch-icon.png">
<meta name="msapplication-TileColor" content="#222c37">
<meta name="msapplication-TileImage" content="../StaticFilesManual/images/favicons/tileicon-144x144.png">
<script type="text/javascript" src="/StaticFilesConfig/UnityVersionsInfo.js"></script><script type="text/javascript" src="../StaticFilesManual/js/jquery.js?ts=20241003"></script><script type="text/javascript" src="../StaticFilesManual/js/core.js?ts=20241003"></script><script type="text/javascript" src="docdata/toc.js?ts=20241003"></script><script type="text/javascript" src="docdata/global_toc.js?ts=20241003"></script><link rel="stylesheet" type="text/css" href="../StaticFilesManual/css/core.css?ts=20241003">
<link rel="stylesheet" href="../StaticFilesManual/css/prism.css">
<script src="../StaticFilesManual/js/prism.js"></script><script src="/StaticFilesConfig/feedback/feedback.js"></script><script src="../StaticFilesManual/js/jquery.sidebar.min.js"></script><link rel="stylesheet" href="../StaticFilesManual/css/mobileoptimisation.css">
<script src="../StaticFilesManual/js/mobileoptimisation.js"></script>
</head>
<body>
<div id="DocsAnalyticsData" data-area="none" data-pagetype="manual"></div>
<div class="header-wrapper">
<div id="header" class="header"><div class="content">
<div class="spacer"><div class="menu">
<div id="nav-open" for="nav-input"><span></span></div>
<div class="logo"><a href="https://docs.unity3d.com"></a></div>
<div class="search-form"><form action="30_search.html" method="get" class="apisearch">
<input type="text" name="q" placeholder="Search manual..." autosave="Unity Reference" results="5" class="sbox field" id="q"><input type="submit" class="submit">
</form></div>
<ul>
<li><a href="../Manual/index.html" class="selected">Manual</a></li>
<li><a href="../ScriptReference/index.html">Scripting API</a></li>
</ul>
</div></div>
<div class="more">
<div class="filler"></div>
<ul><li><a href="https://unity.com/">unity.com</a></li></ul>
</div>
</div></div>
<div class="toolbar"><div class="content">
<div class="toggle version-number" id="VersionNumber" data-target=".otherversionscontent">
                                Version: <b>2022.3</b><div class="otherversionscontent" id="OtherVersionsContent" style="display: none;">
<ul id="OtherVersionsContentUl"></ul>
<div id="otherVersionsLegend"><ul>
<li>
<div id="supportedColour" class="legendBox"></div>Supported</li>
<li>
<div id="notFoundColour" class="legendBox"></div>Legacy</li>
</ul></div>
</div>
<div id="VersionSwitcherArrow" class="arrow versionSwitcherArrow"></div>
</div>
<div class="lang-switcher"><div class="current toggle" data-target=".lang-list">
<div class="lbl">Language
:                <span class="b">English</span>
</div>
<div class="arrow"></div>
<div class="lang-list" style="display:none;"><ul>
<li><a href="/Manual/dots-instancing-shaders.html">English</a></li>
<li><a href="/cn/current/Manual/dots-instancing-shaders.html">中文</a></li>
<li><a href="/ja/current/Manual/dots-instancing-shaders.html">日本語</a></li>
<li><a href="/kr/current/Manual/dots-instancing-shaders.html">한국어</a></li>
</ul></div>
</div></div>
</div></div>
<div class="mobileLogo"><a href="https://docs.unity3d.com"></a></div>
</div>
<div id="master-wrapper" class="master-wrapper clear">
<div id="sidebar" class="sidebar"><div class="sidebar-wrap"><div class="content"><div class="sidebar-menu"><div class="toc" id="customScrollbar">
<h2>Unity Manual</h2>
<div class="search-form sidebar-search-form"><form action="30_search.html" method="get" class="apisearch">
<input type="text" name="q" placeholder="Search manual..." autosave="Unity Reference" results="5" class="sbox field" id="q"><input type="submit" id="mobileSearchBtn" class="submit" value="Search">
</form></div>
<div class="toggle version-number sidebar-version-switcher" id="VersionNumber" data-target=".otherversionscontent"><form id="otherVersionsContentMobileForm"><div class="ui-field-contain">
<label for="select-native-4">Version: 2022.3</label><select name="select-native-4" id="versionsSelectMobile"><option>Select a different version</option>
<optgroup id="versionsWithThisPageMobile" label="Versions with this page"></optgroup>
<optgroup id="versionsWithoutThisPageMobile" label="Versions without this page"></optgroup></select>
</div></form></div>
<div class="lang-switcher"><div class="current toggle" data-target=".lang-list">
<div class="lbl">Language
:                <span class="b">English</span>
</div>
<div class="arrow"></div>
<div class="lang-list" style="display:none;"><ul>
<li><a href="/Manual/dots-instancing-shaders.html">English</a></li>
<li><a href="/cn/current/Manual/dots-instancing-shaders.html">中文</a></li>
<li><a href="/ja/current/Manual/dots-instancing-shaders.html">日本語</a></li>
<li><a href="/kr/current/Manual/dots-instancing-shaders.html">한국어</a></li>
</ul></div>
</div></div>
</div></div></div></div></div>
<div id="content-wrap" class="content-wrap"><div class="content-block"><div class="content">
<div class="section">
<div class="breadcrumbs clear"><ul>
<li><a href="Graphics.html">Graphics</a></li>
<li><a href="graphics-performance-profiling.html">Graphics performance and profiling</a></li>
<li><a href="batch-renderer-group.html">BatchRendererGroup</a></li>
<li>DOTS Instancing shaders</li>
</ul></div>
<div class="mb20"><div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="batch-renderer-group-creating-draw-commands.html"></a></span><div class="tip">Creating draw commands</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="RenderingStatistics.html"></a></span><div class="tip">The Rendering Statistics window</div>
</div>
</div></div>
<div id="_leavefeedback"></div>
<h1>DOTS Instancing shaders</h1>
<!--BeginSwitchLink--><!--EndSwitchLink-->
<div class="clear"></div>

<p>To render large instance counts efficiently, BRG uses a new <span class="tooltip"><strong>shader</strong><span class="tooltiptext">A program that runs on the GPU. <a class="tooltipMoreInfoLink" href="Shaders.html">More info</a><br/><span class="tooltipGlossaryLink">See in <a href="Glossary.html#Shader">Glossary</a></span></span></span> instancing mode called DOTS Instancing. Every shader that BRG uses must support DOTS Instancing. In traditional instanced shaders, the shader is passed an array for each instanced property in a constant or uniform buffer, such that each element in each array contains the property value for a single instance in the draw. In DOTS Instanced shaders, Unity passes one 32-bit integer to the shader for each DOTS Instanced property. This 32-bit integer is called a metadata value. This integer can represent anything you want, but typically it represents an offset in the buffer from where the shader loads property data for the instance that the shader is rendering.</p>

<p>DOTS Instancing has many advantages compared to traditional instancing, including the following:</p>

<ul>
<li>The instance data is stored in a GraphicsBuffer and remains persistent on the GPU, which means that Unity doesn’t need to set it up again each time it renders the instance. Setting up data only when an instance actually changes can significantly improve performance in cases where instance data changes rarely or not at all. This is much more efficient than traditional instancing, which requires an engine to set up all data for every instance every frame.</li>
<li>The process for setting up instance data is separate from setting up the draw call. This makes draw call setup lightweight and efficient. BRG makes this possible with a special fast path of the SRP Batcher that only does a minimal amount of work for each draw call. The responsibility for this work moves to you and gives you more control over what to render in each draw call.</li>
<li>The size of a draw call is no longer limited by how much instance data can fit in a constant or uniform buffer. This makes it possible for BRG to render larger instance counts with a single draw call.
 <br><strong>Note</strong>: The number of instance indices still limits the draw call size, since each index still requires some data. However, an index consumes far less memory than a full set of instanced properties which means many more instances can fit inside a constant or uniform buffer. For example, each index requires 16 byes so if the memory limit for a buffer on a particular platform is 64kb, 4096 indices can fit in the buffer.</li>
<li>If every instance uses the same value for a given property, it is possible to have all instances load the value from the same place in memory. This saves memory and the number of GPU cycles spent duplicating the value for each instance.</li>
</ul>

<h2>Supporting DOTS Instancing</h2>

<p>To support DOTS Instancing, a shader needs to do the following:</p>

<ul>
<li>Use shader model 4.5 or newer. Specify <code>#pragma target 4.5</code> or higher.</li>
<li>Support the <code>DOTS_INSTANCING_ON</code> keyword. Declare this with <code>#pragma multi_compile _ DOTS_INSTANCING_ON</code>.</li>
<li>Declare at least one block of DOTS Instanced properties each of which has least one property. For more information, see <a href="#declaring-dots-instanced-properties">Declaring DOTS Instanced properties</a>.</li>
</ul>

<p>
<strong>Note</strong>: Shader Graphs and shaders that Unity provides in URP and HDRP support DOTS Instancing.</p>

<p><a name="declaring-dots-instanced-properties"></a></p>

<h2>Declaring DOTS Instanced properties</h2>

<p>To load instance data, such as transform matrices, the shader needs to define DOTS Instanced properties. Below is an example of a simple DOTS Instanced property block:</p>

<pre><code>UNITY_DOTS_INSTANCING_START(MaterialPropertyMetadata)
    UNITY_DOTS_INSTANCED_PROP(float4, Color)
UNITY_DOTS_INSTANCING_END(MaterialPropertyMetadata)
</code></pre>

<p>To mark the beginning and end of the property block, use the <code>UNITY_DOTS_INSTANCING_START</code> and <code>UNITY_DOTS_INSTANCING_END</code> macros followed by the name of the block. The example uses the name <code>MaterialPropertyMetadata</code>. There are three allowed block names:</p>

<ul>
<li>BuiltinPropertyMetadata</li>
<li>MaterialPropertyMetadata</li>
<li>UserPropertyMetadata</li>
</ul>

<p>The shader can declare one of each, so a DOTS Instanced shader can have between zero and three of such blocks. Unity-defined shader code doesn’t use UserPropertyMetadata so this name is guaranteed to be free for you to use. URP and HDRP define BuiltinPropertyMetadata for every shader they provide and define MaterialPropertyMetadata for most of them too, so it’s best practice to use UserPropertyMetadata. Your custom shaders can use all three possible names, even all at once.</p>

<p>The block can contain any number of DOTS Instanced property definitions formatted like:</p>

<pre><code>UNITY_DOTS_INSTANCED_PROP(PropertyType, PropertyName)
</code></pre>

<p>
<code>PropertyType</code> can be any HLSL built-in type (like uint, float4, float4x4, or int2x4) except a bool vector, and <code>PropertyName</code> is the name of the DOTS Instanced property. DOTS Instanced properties are completely separate from <a href="SL-Properties.html">regular material properties</a>, and you can give them the same name as another regular material property. This is possible because the <code>UNITY_DOTS_INSTANCED_PROP</code> macro generates special constant names which Unity recognizes that don’t conflict with other property names. Shaders that Unity provides give DOTS Instanced properties the same names as regular material properties, but you don’t need to follow this convention.</p>

<p>Internally, Unity provides the shader with a 32-bit integer metadata value for every DOTS Instanced property the shader declares. Unity sets the metadata value when your code makes a <a href="../ScriptReference/Rendering.BatchRendererGroup.AddBatch.html">BatchRendererGroup.AddBatch</a> call to create the batch associated with the draw. The metadata value defaults to <code>0</code> if Unity doesn’t set it. The shader also has access to <code>ByteAddressBuffer unity_DOTSInstanceData</code> which Unity sets to the GraphicsBuffer you pass as an argument to <code>BatchRendererGroup.AddBatch</code>. This buffer is typically where the shader loads the instance data from. Multiple batches can share a single GraphicsBuffer, but it is also possible for each batch to use its own separate GraphicsBuffer for <code>unity_DOTSInstanceData</code>.</p>

<p>
<strong>Note</strong>: Unity doesn’t provide any DOTS Instanced data automatically. It’s your responsibility to make sure that the <code>unity_DOTSInstanceData</code> buffer of each batch contains the correct data. Instance data must include many properties that are Unity normally provides for <span class="tooltip"><strong>GameObjects</strong><span class="tooltiptext">The fundamental object in Unity scenes, which can represent characters, props, scenery, cameras, waypoints, and more. A GameObject’s functionality is defined by the Components attached to it. <a class="tooltipMoreInfoLink" href="class-GameObject.html">More info</a><br/><span class="tooltipGlossaryLink">See in <a class="tooltipMoreInfoLink" href="Glossary.html#GameObject">Glossary</a></span></span></span>, such as transform matrices, <span class="tooltip"><strong>light probe</strong><span class="tooltiptext">Light probes store information about how light passes through space in your scene. A collection of light probes arranged within a given space can improve lighting on moving objects and static LOD scenery within that space. <a href="LightProbes.html">More info</a><br/><span class="tooltipGlossaryLink">See in <a class="tooltipMoreInfoLink" href="Glossary.html#LightProbe">Glossary</a></span></span></span> coefficients, and <span class="tooltip"><strong>lightmap</strong><span class="tooltiptext">A pre-rendered texture that contains the effects of light sources on static objects in the scene. Lightmaps are overlaid on top of scene geometry to create the effect of lighting. <a href="Lightmapping.html">More info</a><br/><span class="tooltipGlossaryLink">See in <a href="Glossary.html#Lightmap">Glossary</a></span></span></span> texture coordinates.</p>

<p><a name="accessing-dots-instanced-properties"></a></p>

<h2>Accessing DOTS Instanced properties</h2>

<p>To access DOTS Instanced properties, your shader can use one of the access macros that Unity provides. The access macros assume that instance data in <code>unity_DOTSInstanceData</code> uses the following layout:</p>

<ul>
<li>The 31 least significant bits of the metadata value contain the byte address of the first instance in the batch within the <code>unity_DOTSInstanceData</code> buffer.</li>
<li>If the most significant bit of the metadata value is <code>0</code>, every instance uses the value from instance index zero. This means each instance loads directly from the byte address in the metadata value. In this case, the buffer only needs to store a single value, instead of one value per instance.</li>
<li>If the most significant bit of the metadata value is <code>1</code>, the address should contain an array where you can find the value for instance index <code>instanceID</code> using <code>AddressOfInstance0 + sizeof(PropertyType) * instanceID</code>. In this case, you should ensure that every rendered instance index has valid data in buffer. Otherwise, out-of-bounds access and undefined behavior can occur.</li>
</ul>

<p>You can also set the the metadata value directly which is useful if you want to use a custom data source that doesn’t use the above layout, such as a texture.</p>

<p>Unity provides the following access macros:</p>

<table>
<colgroup>
<col style="text-align:left;">
<col style="text-align:left;">
</colgroup>

<thead>
<tr>
	<th style="text-align:left;"><strong>Access macro</strong></th>
	<th style="text-align:left;"><strong>Description</strong></th>
</tr>
</thead>

<tbody>
<tr>
	<td style="text-align:left;"><code>UNITY_ACCESS_DOTS_INSTANCED_PROP(PropertyType, PropertyName)</code></td>
	<td style="text-align:left;">Returns the value loaded from <code>unity_DOTSInstanceData</code> using the layout described above. Shaders that Unity provides use this version for DOTS Instanced built-in properties that don’t have a default value to fall back on.</td>
</tr>
<tr>
	<td style="text-align:left;"><code>UNITY_ACCESS_DOTS_INSTANCED_PROP_WITH_DEFAULT(PropertyType, PropertyName)</code></td>
	<td style="text-align:left;">Returns the same as <code>UNITY_ACCESS_DOTS_INSTANCED_PROP</code>, except if the most significant bit of the metadata value is zero, it returns a default value. The default value is the value of the regular material property with the same name as the DOTS Instanced property, which is why Shaders that Unity provides use the convention where DOTS Instanced properties have the same name as regular material properties. When using the default value, the access macro doesn’t access <code>unity_DOTSInstanceData</code> at all. Shaders that Unity provides use this access macro for DOTS Instanced material properties, so the loads fall back to the value set on the material.</td>
</tr>
<tr>
	<td style="text-align:left;"><code>UNITY_ACCESS_DOTS_INSTANCED_PROP_WITH_CUSTOM_DEFAULT(PropertyType, PropertyName, DefaultValue)</code></td>
	<td style="text-align:left;">Returns the same as <code>UNITY_ACCESS_DOTS_INSTANCED_PROP</code> unless the most significant bit of the metadata value is zero, in which case this macroreturns <code>DefaultValue</code> instead, and doesn’t access <code>unity_DOTSInstanceData</code>.</td>
</tr>
<tr>
	<td style="text-align:left;"><code>UNITY_DOTS_INSTANCED_METADATA_NAME(PropertyType, PropertyName)</code></td>
	<td style="text-align:left;">Returns the metadata value directly without accessing anything. This is useful for custom instance data loading schemes.</td>
</tr>
</tbody>
</table>

<p>For an example of how to use these macros, see <a href="#access-macro-examples">Access macro example</a>.</p>

<p>Alongside the access macros, Unity provides shader functions that load the values of constants directly from the draw command data. Shaders that Unity provides use these functions. </p>

<p>Unity provides the following shader functions:</p>

<table>
<colgroup>
<col style="text-align:left;">
<col style="text-align:left;">
</colgroup>

<thead>
<tr>
	<th style="text-align:left;"><strong>Shader function</strong></th>
	<th style="text-align:left;"><strong>Description</strong></th>
</tr>
</thead>

<tbody>
<tr>
	<td style="text-align:left;"><code>LoadDOTSInstancedData_RenderingLayer</code></td>
	<td style="text-align:left;">Returns the <a href="../ScriptReference/Rendering.BatchFilterSettings-renderingLayerMask.html">renderingLayerMask</a> for the draw command.</td>
</tr>
<tr>
	<td style="text-align:left;"><code>LoadDOTSInstancedData_MotionVectorsParams</code></td>
	<td style="text-align:left;">Returns the <a href="../ScriptReference/Rendering.BatchFilterSettings-motionMode.html">motion vector generation mode</a> for the draw command. This is formatted as a float4, which is what Unity shaders expect.</td>
</tr>
<tr>
	<td style="text-align:left;"><code>LoadDOTSInstancedData_WorldTransformParams</code></td>
	<td style="text-align:left;">Returns whether to draw the instance with a flipped triangle winding. See <a href="../ScriptReference/Rendering.BatchDrawCommandFlags.FlipWinding.html">FlipWinding</a>.</td>
</tr>
<tr>
	<td style="text-align:left;"><code>LoadDOTSInstancedData_LightData</code></td>
	<td style="text-align:left;">Returns whether the <span class="tooltip"><strong>scene</strong><span class="tooltiptext">A Scene contains the environments and menus of your game. Think of each unique Scene file as a unique level. In each Scene, you place your environments, obstacles, and decorations, essentially designing and building your game in pieces. <a class="tooltipMoreInfoLink" href="CreatingScenes.html">More info</a><br/><span class="tooltipGlossaryLink">See in <a href="Glossary.html#Scene">Glossary</a></span></span></span>’s main Directional Light is active for the instance. The main light can be deactivated for multiple reasons, for example if the light already included in light maps.</td>
</tr>
<tr>
	<td style="text-align:left;"><code>LoadDOTSInstancedData_LODFade</code></td>
	<td style="text-align:left;">Returns the 8 bit crossfade value you set if the <a href="../ScriptReference/Rendering.BatchDrawCommandFlags.LODCrossFade.html">LODCrossFade flag</a> is set. If the flag is not set, the return value is undefined.</td>
</tr>
</tbody>
</table>

<p><a name="access-macro-examples"></a></p>

<h3>Access macro examples</h3>

<p>This section contains examples of the access macros that Unity provides and instructions for how to use these macros to access per-instance data and constant data.</p>

<h4>Per-instance</h4>

<p>In this example:</p>

<ul>
<li>The metadata value for <code>Color</code> is <code>0x80001000</code>.</li>
<li>The instance index is <code>5</code>.</li>
<li>Data for instance 0 starts at address 0x1000.</li>
<li>Data for instance 5 is at address 0x1000 + 5 * sizeof(float4) = 0x1050</li>
</ul>

<p>Because the most significant bit is already set, the accessor macros don’t load defaults. This means that <code>c0</code>, <code>c1</code>, and <code>c2</code> will all have the same value, loaded from <code>unity_DOTSInstanceData</code> address <code>0x1050</code>.</p>

<pre><code>void ExamplePerInstance()
{
    // rawMetadataValue will contain 0x80001000
    uint rawMetadataValue = UNITY_DOTS_INSTANCED_METADATA_NAME(float4, Color);

    float4 c0 = UNITY_ACCESS_DOTS_INSTANCED_PROP(float4, Color);
    float4 c1 = UNITY_ACCESS_DOTS_INSTANCED_PROP_WITH_DEFAULT(float4, Color);
    float4 c2 = UNITY_ACCESS_DOTS_INSTANCED_PROP_WITH_CUSTOM_DEFAULT(float4, Color, float4(1, 2, 3, 4));
}
</code></pre>

<h4>Constant</h4>

<p>In this example:</p>

<ul>
<li>The metadata value for <code>Color</code> is <code>0x00001000</code>.</li>
<li>The instance index is <code>5</code>.</li>
<li>Data for instance 0 starts at address 0x1000.</li>
<li>The most significant bit is not set so data for instance 5 is at the same address as instance 0.</li>
</ul>

<p>Because the most significant bit is not set, the accessor macros that fall back to defaults don’t access <code>unity_DOTSInstanceData</code>. This means that:</p>

<ul>
<li>
<code>c0</code> will contain the value from <code>unity_DOTSInstanceData</code> address <code>0x1000</code>.</li>
<li>
<code>c1</code> will contain the value of the regular material property <strong>Color</strong>, and cause a compile error if the Color property doesn’t exist.</li>
<li>
<code>c2</code> will contain <code>(1, 2, 3, 4)</code> because that was passed as the explicit default value.</li>
</ul>

<pre><code>void ExampleConstant()
{
    // rawMetadataValue will contain 0x00001000
    uint rawMetadataValue = UNITY_DOTS_INSTANCED_METADATA_NAME(float4, Color);
    float4 c0 = UNITY_ACCESS_DOTS_INSTANCED_PROP(float4, Color);
    float4 c1 = UNITY_ACCESS_DOTS_INSTANCED_PROP_WITH_DEFAULT(float4, Color);
    float4 c2 = UNITY_ACCESS_DOTS_INSTANCED_PROP_WITH_CUSTOM_DEFAULT(float4, Color, float4(1, 2, 3, 4));
}
</code></pre>

<h3>Advanced DOTS Instanced properties usage</h3>

<p>The <code>UNITY_DOTS_INSTANCED_PROP</code> macro has 3 variants: </p>

<ul>
<li><code>UNITY_DOTS_INSTANCED_PROP_OVERRIDE_DISABLED(PropertyType, PropertyName)</code></li>
<li><code>UNITY_DOTS_INSTANCED_PROP_OVERRIDE_SUPPORTED(PropertyType, PropertyName)</code></li>
<li><code>UNITY_DOTS_INSTANCED_PROP_OVERRIDE_REQUIRED(PropertyType, PropertyName)</code></li>
</ul>

<p>These macros allow you to specify if a property can be instanced or not at compile-time. It allows the access macros such as <code>UNITY_ACCESS_DOTS_INSTANCED_PROP</code> to expand to more optimal code and can have significant impact on low-end platforms. </p>

<p>Here is an example of a DOTS Instanced property block using all the macro variants above:</p>

<pre><code>UNITY_DOTS_INSTANCING_START(MaterialPropertyMetadata)
    UNITY_DOTS_INSTANCED_PROP_OVERRIDE_SUPPORTED(float4, Color)
    UNITY_DOTS_INSTANCED_PROP_OVERRIDE_DISABLED(float4, SpecColor)
    UNITY_DOTS_INSTANCED_PROP_OVERRIDE_REQUIRED(float4, EmissionColor)
UNITY_DOTS_INSTANCING_END(MaterialPropertyMetadata)
</code></pre>

<p>Here is what this declaration means:</p>

<ul>
<li>The <code>Color</code> property can either be instanced or not. The correct loading path is selected dynamically depending on the property metadata high-bit.</li>
<li>The <code>SpecColor</code> property is not instantiable. This declaration won’t add an uint32 field in the constant buffer. It is equivalent to not declaring anything at all. It can be useful to quickly disable instancing on a property without the need to modify other parts of the code.</li>
<li>The <code>EmissionColor</code> property must be instanced. The property is always loaded from the <code>unity_DOTSInstanceData</code> buffer, and no dynamic branch is ever emitted when accessing the property.</li>
</ul>

<p>By default, <code>UNITY_DOTS_INSTANCED_PROP</code> is the same as <code>UNITY_DOTS_INSTANCED_PROP_OVERRIDE_SUPPORTED</code>. This default behavior can be changed by uncommenting the define <code>UNITY_DOTS_INSTANCED_PROP_OVERRIDE_DISABLED_BY_DEFAULT</code> in “com.unity.render-pipelines.core\ShaderLibrary\UnityDOTSInstancing.hlsl”. When you do this, the define is enabled, and <code>UNITY_DOTS_INSTANCED_PROP</code> becomes the same as <code>UNITY_DOTS_INSTANCED_PROP_OVERRIDE_DISABLED</code>.</p>

<p>
<strong>Note</strong>: When uncommenting the define <code>UNITY_DOTS_INSTANCED_PROP_OVERRIDE_DISABLED_BY_DEFAULT</code>, you might need to clear the Library folder to make sure the shaders are correctly recompiled.</p>

<p>On low-end devices, instanced properties can have a significant performance cost. Loading from an SSBO for example, can be a lot slower than a normal constant buffer load. This is because on many low-end devices, this type of buffer load goes through texture samplers, whereas constant buffer loads uses faster hardware unless a dynamic index is used to access the buffer. Instanced properties are always loaded with dynamic indexing since it depends on the property metadata, this means they always go through the texture samplers on low-end devices.
To better optimize your project for low-end devices, you can disable property instancing by default. To do this, enable the define <code>UNITY_DOTS_INSTANCED_PROP_OVERRIDE_DISABLED_BY_DEFAULT</code>, this sets property instancing to be disabled as default. Once this is done, you can then enable property instancing manually only for the properties that require it.</p>

<h2>Details</h2>

<p>It is best practice to initialize the first 64 bytes of all <code>unity_DOTSInstanceData</code> buffers to zero and leave them unused. This is because the default metadata value that Unity uses for all metadata values not specified during batch creation is zero. Specifically, when a shader loads a zero metadata value from the <code>UNITY_ACCESS_DOTS_INSTANCED_PROP</code> macro, the shader loads this value from the address <code>zero</code> because the instance index will be disregarded. Ensuring that the first 64 bytes, which is the size of the largest value type (a float4x4 matrix), are zeroes guarantees that such loads predictably return a result of zero. Otherwise, the shader could load something unpredictable, depending on what happens to be located at address zero.</p>

<p>When using DOTS Instancing, Shader Graphs and Shaders that Unity provides use a special convention for transform matrices. To save GPU memory and bandwidth, they store these matrices using only 12 floats instead of the full 16, because four floats are always constant. These shaders expect floats formatted in such a way that the x, y, and z of each column in the matrix are stored in order. In other words, the first three floats are the x, y, and z of the first column, the next three floats are the x, y, and z of the second column, and so on. The matrices don’t store the <code>w</code> element of each column. The transform matrices this affects are:</p>

<ul>
<li><code>unity_ObjectToWorld</code></li>
<li><code>unity_WorldToObject</code></li>
<li><code>unity_MatrixPreviousM</code></li>
<li><code>unity_MatrixPreviousMI</code></li>
</ul>

<p>The following code sample includes a struct that converts regular four-by-four matrices into the 12 floats convention.</p>

<pre><code class="lang-csharp">struct PackedMatrix
{
    public float c0x;
    public float c0y;
    public float c0z;
    public float c1x;
    public float c1y;
    public float c1z;
    public float c2x;
    public float c2y;
    public float c2z;
    public float c3x;
    public float c3y;
    public float c3z;

    public PackedMatrix(Matrix4x4 m)
    {
        c0x = m.m00;
        c0y = m.m10;
        c0z = m.m20;
        c1x = m.m01;
        c1y = m.m11;
        c1z = m.m21;
        c2x = m.m02;
        c2y = m.m12;
        c2z = m.m22;
        c3x = m.m03;
        c3y = m.m13;
        c3z = m.m23;
    }
}
</code></pre>
<div id="_content"></div>
<div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="batch-renderer-group-creating-draw-commands.html"></a></span><div class="tip">Creating draw commands</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="RenderingStatistics.html"></a></span><div class="tip">The Rendering Statistics window</div>
</div>
</div>
</div>
<div class="footer-wrapper"><div class="footer clear">
<div class="copy">Copyright © 2024 Unity Technologies. Publication Date: 2024-10-03.</div>
<div class="menu">
<a href="https://learn.unity.com/">Tutorials</a><a href="https://answers.unity3d.com">Community Answers</a><a href="https://support.unity3d.com/hc/en-us">Knowledge Base</a><a href="https://forum.unity3d.com">Forums</a><a href="https://unity3d.com/asset-store">Asset Store</a><a href="https://docs.unity3d.com/Manual/TermsOfUse.html">Terms of use</a><a href="https://unity.com/legal">Legal</a><a href="https://unity.com/legal/privacy-policy">Privacy Policy</a><a href="https://unity.com/legal/cookie-policy">Cookies</a><a href="https://unity.com/legal/do-not-sell-my-personal-information">Do Not Sell or Share My Personal Information</a><div id="ot-sdk-btn-container"><a id="ot-sdk-btn" class="ot-sdk-show-settings" href="javascript:void(0);">Your Privacy Choices (Cookie Settings)</a></div>
</div>
</div></div>
</div></div></div>
</div>
</body>
</html>
