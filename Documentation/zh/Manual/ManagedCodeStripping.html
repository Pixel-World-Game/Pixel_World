<!DOCTYPE html><html class="no-js" lang="zh-cn">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link href="https://fonts.googleapis.com/css?family=Roboto&amp;display=swap" rel="stylesheet">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="twitter:card" content="summary">
<meta property="og:title" content="托管代码剥离 - Unity 手册">
<title>托管代码剥离 - Unity 手册</title>
<meta property="og:image" content="https://docs.unity3d.com/cn/2022.3/uploads/Main/managed-code-stripping-level.png">
<meta name="description" content="During the build process, Unity removes unused or unreachable code through a process called managed code stripping, which can significantly decrease your application’s final size. Managed code stripping removes code from managed assemblies, including assemblies built from the C# scripts in your project, assemblies that are part of packages and plugins, and assemblies in .NET Framework.">
<meta property="og:description" content="During the build process, Unity removes unused or unreachable code through a process called managed code stripping, which can significantly decrease your application’s final size. Managed code stripping removes code from managed assemblies, including assemblies built from the C# scripts in your project, assemblies that are part of packages and plugins, and assemblies in .NET Framework.">
<meta name="author" content="Unity Technologies">
<link rel="shortcut icon" href="https://unity.com/themes/contrib/unity_base/images/favicons/favicon.ico">
<link rel="icon" type="image/png" href="../StaticFiles/images/favicons/favicon.png">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="../StaticFiles/images/favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../StaticFiles/images/favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="../StaticFiles/images/favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../StaticFiles/images/favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="../StaticFiles/images/favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon-precomposed" href="../StaticFiles/images/favicons/apple-touch-icon.png">
<meta name="msapplication-TileColor" content="#222c37">
<meta name="msapplication-TileImage" content="../StaticFiles/images/favicons/tileicon-144x144.png">
<script type="text/javascript" src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" charset="UTF-8" data-domain-script="6e91be4c-3145-4ea2-aa64-89d716064836" data-dLayer-ignore="true" data-document-language="true"></script><script type="text/javascript">function OptanonWrapper() {}</script><script>window.dataLayer = window.dataLayer || []; dataLayer.push({ event: 'dataLayer-initialized', user: { user_unity_id: undefined, user_logged_in: 'no' }, environment: { environment_locale: '', environment_currency: undefined }});</script><script>var offline=(location.href.indexOf('docs.unity3d.com')==-1)?true:false;if(!offline){(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=   'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);  })(window,document,'script','dataLayer','GTM-5V25JL6');}</script><script>
      var docs_type = 'Manual';
      var lang = 'cn';
      var page = 'ManagedCodeStripping';
      if(!page) page = 'index';
      var version = '2022.3';
      var docs_versions = [{version: '2023.2',version_string: '2023.2',supported: true},{version: '2023.1',version_string: '2023.1',supported: false},{version: '2022.3',version_string: '2022.3',supported: true},{version: '2022.2',version_string: '2022.2',supported: false},{version: '2022.1',version_string: '2022.1',supported: false},{version: '2021.3',version_string: '2021.3',supported: true},{version: '2021.2',version_string: '2021.2',supported: false},{version: '2021.1',version_string: '2021.1',supported: false},{version: '2020.3',version_string: '2020.3',supported: false},{version: '2020.2',version_string: '2020.2',supported: false},{version: '2020.1',version_string: '2020.1',supported: false},{version: '2019.4',version_string: '2019.4',supported: false},{version: '2019.3',version_string: '2019.3',supported: false},{version: '2019.2',version_string: '2019.2',supported: false},{version: '2019.1',version_string: '2019.1',supported: false},{version: '2018.4',version_string: '2018.4',supported: false},{version: '2018.3',version_string: '2018.3',supported: false},{version: '2018.2',version_string: '2018.2',supported: false},{version: '2018.1',version_string: '2018.1',supported: false},{version: '2017.4',version_string: '2017.4',supported: false},{version: '2017.3',version_string: '2017.3',supported: false},{version: '2017.2',version_string: '2017.2',supported: false},{version: '2017.1',version_string: '2017.1',supported: false},{version: '5.6',version_string: '560',supported: false},];</script><script type="text/javascript" src="../StaticFiles/js/jquery.js"></script><script type="text/javascript" src="../StaticFiles/js/core.js"></script><script type="text/javascript" src="../StaticFiles/js/jquery.sidebar.min.js"></script><script type="text/javascript" src="docdata/toc.js"></script><script type="text/javascript" src=""></script><script type="text/javascript" src="../StaticFiles/js/custom.js"></script><script src="/StaticFilesConfig/feedback/feedback.js"></script><link rel="stylesheet" type="text/css" href="../StaticFiles/css/core.css">
<link rel="stylesheet" type="text/css" href="../StaticFiles/css/custom.css">
<link rel="canonical" href="https://docs.unity3d.com/cn/2022.3/Manual/ManagedCodeStripping.html">
<link rel="alternate" href="https://docs.unity3d.com/en/2022.3/Manual/ManagedCodeStripping.html" hreflang="en">
<link rel="alternate" href="https://docs.unity3d.com/cn/2022.3/Manual/ManagedCodeStripping.html" hreflang="zh">
<link rel="alternate" href="https://docs.unity3d.com/ja/2022.3/Manual/ManagedCodeStripping.html" hreflang="ja">
<link rel="alternate" href="https://docs.unity3d.com/kr/2022.3/Manual/ManagedCodeStripping.html" hreflang="ko">
<link rel="alternate" href="https://docs.unity3d.com/2022.3/Documentation/Manual/ManagedCodeStripping.html" hreflang="x-default">
</head>
<body>
<div class="header-wrapper">
<div id="header" class="header"><div class="content">
<div class="spacer"><div class="menu">
<div id="nav-open" for="nav-input"><span></span></div>
<div class="logo"><a href="./index.html"></a></div>
<div class="search-form"><form action="30_search.html" method="get" class="apisearch">
<input type="text" name="q" placeholder="搜索手册..." autosave="Unity Reference" results="5" class="sbox field" id="q"><input type="submit" class="submit">
</form></div>
<ul class="menu-items">
<li class="menu-item"><a href="../Manual/index.html" class="selected">手册</a></li>
<li class="menu-item"><a href="../ScriptReference/index.html" class="">脚本 API</a></li>
</ul>
</div></div>
<div class="more">
<div class="filler"></div>
<ul><li><a href="https://unity3d.com/">
                unity3d.com
              </a></li></ul>
</div>
</div></div>
<div class="toolbar"><div class="content">
<div class="version-switcher">
<div class="current toggle" data-target=".version-list"><div class="version-number">
<div class="d-inline-block">
          Version:
          <b>2022.3</b>
</div>
<div class="d-inline-block arrow"></div>
</div></div>
<div class="version-list" style="display:none;">
<ul class="versions">
<li class="supported"><a class="docs_version_url_2023.2" href="/cn/2023.2/Manual/ManagedCodeStripping.html">2023.2</a></li>
<li class=""><a class="docs_version_url_2023.1" href="/cn/2023.1/Manual/ManagedCodeStripping.html">2023.1</a></li>
<li class="supported"><a class="docs_version_url_2022.3" href="/cn/2022.3/Manual/ManagedCodeStripping.html">2022.3</a></li>
<li class=""><a class="docs_version_url_2022.2" href="/cn/2022.2/Manual/ManagedCodeStripping.html">2022.2</a></li>
<li class=""><a class="docs_version_url_2022.1" href="/cn/2022.1/Manual/ManagedCodeStripping.html">2022.1</a></li>
<li class="supported"><a class="docs_version_url_2021.3" href="/cn/2021.3/Manual/ManagedCodeStripping.html">2021.3</a></li>
<li class=""><a class="docs_version_url_2021.2" href="/cn/2021.2/Manual/ManagedCodeStripping.html">2021.2</a></li>
<li class=""><a class="docs_version_url_2021.1" href="/cn/2021.1/Manual/ManagedCodeStripping.html">2021.1</a></li>
<li class=""><a class="docs_version_url_2020.3" href="/cn/2020.3/Manual/ManagedCodeStripping.html">2020.3</a></li>
<li class=""><a class="docs_version_url_2020.2" href="/cn/2020.2/Manual/ManagedCodeStripping.html">2020.2</a></li>
<li class=""><a class="docs_version_url_2020.1" href="/cn/2020.1/Manual/ManagedCodeStripping.html">2020.1</a></li>
<li class=""><a class="docs_version_url_2019.4" href="/cn/2019.4/Manual/ManagedCodeStripping.html">2019.4</a></li>
<li class=""><a class="docs_version_url_2019.3" href="/cn/2019.3/Manual/ManagedCodeStripping.html">2019.3</a></li>
<li class=""><a class="docs_version_url_2019.2" href="/cn/2019.2/Manual/ManagedCodeStripping.html">2019.2</a></li>
<li class=""><a class="docs_version_url_2019.1" href="/cn/2019.1/Manual/ManagedCodeStripping.html">2019.1</a></li>
<li class=""><a class="docs_version_url_2018.4" href="/cn/2018.4/Manual/ManagedCodeStripping.html">2018.4</a></li>
<li class=""><a class="docs_version_url_2018.3" href="/cn/2018.3/Manual/ManagedCodeStripping.html">2018.3</a></li>
<li class=""><a class="docs_version_url_2018.2" href="/cn/2018.2/Manual/ManagedCodeStripping.html">2018.2</a></li>
<li class=""><a class="docs_version_url_2018.1" href="/cn/2018.1/Manual/ManagedCodeStripping.html">2018.1</a></li>
<li class=""><a class="docs_version_url_2017.4" href="/cn/2017.4/Manual/ManagedCodeStripping.html">2017.4</a></li>
<li class=""><a class="docs_version_url_2017.3" href="/cn/2017.3/Manual/ManagedCodeStripping.html">2017.3</a></li>
<li class=""><a class="docs_version_url_2017.2" href="/cn/2017.2/Manual/ManagedCodeStripping.html">2017.2</a></li>
<li class=""><a class="docs_version_url_2017.1" href="/cn/2017.1/Manual/ManagedCodeStripping.html">2017.1</a></li>
<li class=""><a class="docs_version_url_560" href="/cn/560/Manual/ManagedCodeStripping.html">5.6</a></li>
<div class="versionsWithThisPage" style="display:none;"><li><p>包含此页的版本：</p></li></div>
<div class="versionsWithoutThisPage" style="display:none;"><li><p>不含此页的版本：</p></li></div>
</ul>
<ul class="description">
<li>
<div class="supported-box"></div>受支持</li>
<li>
<div class="legacy-box"></div>旧版</li>
</ul>
</div>
</div>
<ul class="nav-menu-items">
<li class="menu-item"><a href="../Manual/index.html" class="selected">手册</a></li>
<li class="menu-item"><a href="../ScriptReference/index.html" class="">脚本 API</a></li>
</ul>
<div class="lang-switcher">
<div class="current toggle" data-target=".lang-list">
<div class="lbl">语言:
        <span class="b">中文</span>
</div>
<div class="arrow"></div>
</div>
<div class="lang-list" style="display:none;"><ul>
<li><a data-lang="en" href="/2022.3/Documentation/Manual/ManagedCodeStripping.html">English</a></li>
<li><a data-lang="cn" href="/cn/2022.3/Manual/ManagedCodeStripping.html">中文</a></li>
<li><a data-lang="ja" href="/ja/2022.3/Manual/ManagedCodeStripping.html">日本語</a></li>
<li><a data-lang="kr" href="/kr/2022.3/Manual/ManagedCodeStripping.html">한국어</a></li>
</ul></div>
</div>
</div></div>
</div>
<div id="master-wrapper" class="master-wrapper clear">
<div id="sidebar" class="sidebar hidden"><div class="sidebar-wrap"><div class="content"><div class="sidebar-menu"><div class="toc">
<h2>手册</h2>
<div class="version-switcher">
<div class="current toggle" data-target=".version-list"><div class="version-number">
<div class="d-inline-block">
          Version:
          <b>2022.3</b>
</div>
<div class="d-inline-block arrow"></div>
</div></div>
<div class="version-list" style="display:none;">
<ul class="versions">
<li class="supported"><a class="docs_version_url_2023.2" href="/cn/2023.2/Manual/ManagedCodeStripping.html">2023.2</a></li>
<li class=""><a class="docs_version_url_2023.1" href="/cn/2023.1/Manual/ManagedCodeStripping.html">2023.1</a></li>
<li class="supported"><a class="docs_version_url_2022.3" href="/cn/2022.3/Manual/ManagedCodeStripping.html">2022.3</a></li>
<li class=""><a class="docs_version_url_2022.2" href="/cn/2022.2/Manual/ManagedCodeStripping.html">2022.2</a></li>
<li class=""><a class="docs_version_url_2022.1" href="/cn/2022.1/Manual/ManagedCodeStripping.html">2022.1</a></li>
<li class="supported"><a class="docs_version_url_2021.3" href="/cn/2021.3/Manual/ManagedCodeStripping.html">2021.3</a></li>
<li class=""><a class="docs_version_url_2021.2" href="/cn/2021.2/Manual/ManagedCodeStripping.html">2021.2</a></li>
<li class=""><a class="docs_version_url_2021.1" href="/cn/2021.1/Manual/ManagedCodeStripping.html">2021.1</a></li>
<li class=""><a class="docs_version_url_2020.3" href="/cn/2020.3/Manual/ManagedCodeStripping.html">2020.3</a></li>
<li class=""><a class="docs_version_url_2020.2" href="/cn/2020.2/Manual/ManagedCodeStripping.html">2020.2</a></li>
<li class=""><a class="docs_version_url_2020.1" href="/cn/2020.1/Manual/ManagedCodeStripping.html">2020.1</a></li>
<li class=""><a class="docs_version_url_2019.4" href="/cn/2019.4/Manual/ManagedCodeStripping.html">2019.4</a></li>
<li class=""><a class="docs_version_url_2019.3" href="/cn/2019.3/Manual/ManagedCodeStripping.html">2019.3</a></li>
<li class=""><a class="docs_version_url_2019.2" href="/cn/2019.2/Manual/ManagedCodeStripping.html">2019.2</a></li>
<li class=""><a class="docs_version_url_2019.1" href="/cn/2019.1/Manual/ManagedCodeStripping.html">2019.1</a></li>
<li class=""><a class="docs_version_url_2018.4" href="/cn/2018.4/Manual/ManagedCodeStripping.html">2018.4</a></li>
<li class=""><a class="docs_version_url_2018.3" href="/cn/2018.3/Manual/ManagedCodeStripping.html">2018.3</a></li>
<li class=""><a class="docs_version_url_2018.2" href="/cn/2018.2/Manual/ManagedCodeStripping.html">2018.2</a></li>
<li class=""><a class="docs_version_url_2018.1" href="/cn/2018.1/Manual/ManagedCodeStripping.html">2018.1</a></li>
<li class=""><a class="docs_version_url_2017.4" href="/cn/2017.4/Manual/ManagedCodeStripping.html">2017.4</a></li>
<li class=""><a class="docs_version_url_2017.3" href="/cn/2017.3/Manual/ManagedCodeStripping.html">2017.3</a></li>
<li class=""><a class="docs_version_url_2017.2" href="/cn/2017.2/Manual/ManagedCodeStripping.html">2017.2</a></li>
<li class=""><a class="docs_version_url_2017.1" href="/cn/2017.1/Manual/ManagedCodeStripping.html">2017.1</a></li>
<li class=""><a class="docs_version_url_560" href="/cn/560/Manual/ManagedCodeStripping.html">5.6</a></li>
<div class="versionsWithThisPage" style="display:none;"><li><p>包含此页的版本：</p></li></div>
<div class="versionsWithoutThisPage" style="display:none;"><li><p>不含此页的版本：</p></li></div>
</ul>
<ul class="description">
<li>
<div class="supported-box"></div>受支持</li>
<li>
<div class="legacy-box"></div>旧版</li>
</ul>
</div>
</div>
<div class="clear"></div>
</div></div></div></div></div>
<div id="content-wrap" class="content-wrap opened-sidebar"><div class="content-block"><div class="content">
<div class="section">
<div class="breadcrumbs clear"><ul>
<li><a href="UnityManual.html">Unity User Manual 2022.3 (LTS)</a></li>
<li><a href="ScriptingSection.html">脚本</a></li>
<li><a href="unity-architecture.html">Unity 架构</a></li>
<li><a href="scripting-backends.html">脚本后端</a></li>
<li>托管代码剥离</li>
</ul></div>
<div class="mb20"><div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="ScriptingRestrictions.html"></a></span><div class="tip">脚本限制</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="unity-linker.html"></a></span><div class="tip">The Unity linker</div>
</div>
</div></div>
<h1>托管代码剥离</h1>
<!--BeginSwitchLink--><!--EndSwitchLink-->
<div class="clear"></div>

<p>During the build process, Unity removes unused or unreachable code through a process called managed code stripping, which can significantly decrease your application’s final size. Managed code stripping removes code from managed assemblies, including assemblies built from the C# scripts in your project, assemblies that are part of packages and plugins, and assemblies in .NET Framework.</p>

<p>Unity uses a tool called the Unity linker to perform a static analysis of the code in your project’s assemblies. The static analysis identifies any classes, portions of classes, functions, or portions of functions that can’t be reached during execution. This analysis only includes code that exists at build time because runtime generated code doesn’t exist when Unity performs the static analysis.</p>

<p>You can configure the level of code stripping Unity performs for your project using the <strong>Managed Stripping Level</strong> setting. To prevent Unity removing specific parts of your code, use annotations to indicate which parts of your code base the Unity linker should preserve. For more information, see <a href="unity-linker.html">Unity linker</a>.</p>

<h2>Configure managed code stripping</h2>

<figure>
<img src="../uploads/Main/managed-code-stripping-level.png" alt="The Managed Stripping Level property">
<figcaption>The Managed Stripping Level property</figcaption>
</figure>

<p>The <strong>Managed Stripping Level</strong> property determines the set of rules that the Unity linker follows when it analyzes and strips your application’s code. As you increase the setting from <strong>Minimal</strong> to <strong>High</strong>, the rules enable the linker to search through more assemblies for unreachable code. The Unity linker removes more code at the higher settings which reduces the final size of your build, though the expanded search means that each build takes longer to produce.</p>

<p>To change the <strong>Managed Stripping Level</strong> property:</p>

<ol>
<li>Go to <strong>Edit</strong> &gt; <strong>Project Settings</strong> &gt; <strong>Player</strong>.</li>
<li>In Other Settings, navigate to the Optimization heading.</li>
<li>Set the <strong>Managed Stripping Level</strong> property to the desired value.</li>
</ol>

<table>
<colgroup>
<col style="text-align:left;">
<col style="text-align:left;">
</colgroup>

<thead>
<tr>
	<th style="text-align:left;"><strong>属性：</strong></th>
	<th style="text-align:left;"><strong>功能：</strong></th>
</tr>
</thead>

<tbody>
<tr>
	<td style="text-align:left;"><strong>Disabled</strong></td>
	<td style="text-align:left;">Unity doesn’t remove any code.<br><br>This setting is visible only and is the default setting if you use the Mono scripting backend.</td>
</tr>
<tr>
	<td style="text-align:left;"><strong>Minimal</strong></td>
	<td style="text-align:left;">Unity searches only the UnityEngine and the .NET class libraries for unused code. Unity doesn’t remove any user-written code. This setting is the least likely to cause any unexpected runtime behavior.<br><br>This setting is useful for projects where usability is of higher priority than build size.This is the default setting if you use the IL2CPP scripting backend.</td>
</tr>
<tr>
	<td style="text-align:left;"><strong>Low</strong></td>
	<td style="text-align:left;">Unity searches some user-written assemblies and all UnityEngine and .NET class libraries for unused code. This setting applies a set of rules that removes some unused code but minimizes the likelihood of unintended consequences, such as changes in behavior of runtime code that uses reflection.</td>
</tr>
<tr>
	<td style="text-align:left;"><strong>Medium</strong></td>
	<td style="text-align:left;">Unity partially searches all assemblies to find unreachable code. This setting applies a set of rules that strips more types of code patterns to reduce the build size. Although Unity doesn’t strip all possible unreachable code, this setting does increase the risk of undesirable or unexpected behavior changes.</td>
</tr>
<tr>
	<td style="text-align:left;"><strong>High</strong></td>
	<td style="text-align:left;">Unity performs an extensive search of all assemblies to find unreachable code. At this setting, Unity prioritizes size reduction more than code stability and removes as much code as possible.<br><br>This search can take much longer than for lower stripping levels. Use this setting only for projects where a compact build size is extremely important. Test your application thoroughly and make careful use of [Preserve] attributes and link.xml files to ensure that the Unity linker doesn’t strip vital code.</td>
</tr>
</tbody>
</table>

<p><a name="PreserveCodeWithAnnotations"></a></p>

<h2>Preserve code using annotations</h2>

<p>You can use annotations to prevent the Unity linker from stripping specific sections of your code. This is helpful if your application produces runtime code which doesn’t exist when Unity performs the static analysis; for example, through <a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/reflection">reflection</a>. Annotations either provide general guidance to the Unity linker about which code patterns it shouldn’t strip, or instructions not to strip a specific, defined section of code.</p>

<p>There are two broad approaches you can use to annotate your code to preserve it from the managed code stripping process:</p>

<ul>
<li>Root annotations identify parts of your code as roots. The Unity linker doesn’t strip any code that is marked as a root. Root annotations are less complicated to use but can also lead to the Unity linker preserving some code that it should strip.</li>
<li>Dependency annotations define the connections between code elements. Dependency annotations can reduce the amount of over preservation of code compared to root annotations.</li>
</ul>

<p>Each of these techniques provides more control over the amount of code that the Unity linker strips at higher stripping levels and reduces the chance of vital code being stripped. Annotations are especially useful when your code references other code through reflection, because the Unity linker can’t always detect uses of reflection.</p>

<p>Preserve code that uses reflection or generates other code at runtime to significantly reduce the likelihood of unexpected behavior when your application is executed. For examples of reflection patterns that the Unity linker can recognize, see the <a href="https://github.com/Unity-Technologies/linker/tree/unity-master/test/Mono.Linker.Tests.Cases/Reflection">Unity Intermediate Language Linker reflection test suite</a>.</p>

<p><a name="RootAnnotations"></a></p>

<h2>Root annotations</h2>

<p>Root annotations force the Unity linker to treat code elements as roots, which aren’t stripped in the code stripping process. There are two types of root annotations you can use, depending on whether you need to preserve individual types with their constructors or assemblies:</p>

<ul>
<li>
<a href="#PreserveAttribute">Preserve Attribute</a>: Annotates individual types as roots to preserve them.</li>
<li>
<a href="#LinkXMLAnnotation">Link.xml</a>: Annotates assemblies and any types or other code entities within those assemblies as roots to preserve them.</li>
</ul>

<p><a name="PreserveAttribute"></a></p>

<h3>Annotate roots using the Preserve attribute</h3>

<p>Use the <a href="Scriptref:Scripting.PreserveAttribute">Preserve</a> attribute to individually exclude specific sections of your code from the Unity linker’s static analysis. To annotate a piece of code with this attribute, add <code>[Preserve]</code> immediately before the first part of the code you want to preserve. The following list describes what entities the Unity linker preserves when you annotate different code elements with the <code>[Preserve]</code> attribute:</p>

<ul>
<li>
<strong>Assembly</strong>: Preserves all types that are used and defined in the assembly. To assign the <code>[Preserve]</code> attribute to an assembly, place the attribute declaration in any C# file included in the assembly, before any namespace declarations.</li>
<li>
<strong>Type</strong>: Preserves a class or type and its default constructor.</li>
<li>
<strong>Method</strong>: Preserves the method, the type that declares the method, the type the method returns, and the types of all of its arguments.</li>
<li>
<strong>Property</strong>: Preserves the property, the type that declares the property, the value type of the property, and methods that get and set the property value.</li>
<li>
<strong>Field</strong>: Preserves the field, the field type, and the type that declares the field.</li>
<li>
<strong>Event</strong>: Preserves the event, the type that declares the event, type, the type the event returns, the <code>[add]</code> accessor, and the <code>[remove]</code> accessor.</li>
<li>
<strong>Delegate</strong>: Preserves the delegate type and all methods that the delegate invokes.</li>
</ul>

<p>Use the <code>[Preserve]</code> attribute when you want to preserve both a type and its default constructor. If you want to keep one or the other but not both, use a link.xml file.</p>

<p>You can define the <code>[Preserve]</code> attribute in any assembly and in any namespace. You can use the UnityEngine.Scripting.PreserveAttribute class, create a subclass of UnityEngine.Scripting.PreserveAttribute, or create your own <a href="https://docs.unity3d.com/ScriptReference/PreserveAttribute.html">PreserveAttribute</a> class. For example:</p>

<pre><code class="csharp">class Foo
{
    [Preserve]
    public void PreservedMethod(){}
}
</code></pre>

<p><a name="LinkXMLAnnotation"></a></p>

<h3>Annotate roots using a Link XML file</h3>

<p>You can include a .xml file entitled link.xml in your project to preserve a list of specific assemblies or parts of assemblies. The link.xml file must be present in the <code>Assets</code> folder or a subdirectory of the <code>Assets</code> folder in your project and must include the <code>&lt;linker&gt;</code> tag in the file. The Unity linker treats any assembly, type, or member preserved in a link.xml file as a root type.</p>

<p>You can use any number of link.xml files in your project. As a result, you can provide separate preservation declarations for each plugin. You can’t include a link.xml file in a package, but you can reference package assemblies from non-package link.xml files.</p>

<p>The following examples illustrate the different ways that you can declare the root types of a project’s assemblies using a link.xml file:</p>

<pre><code class="xml-doc">&lt;linker&gt;
  &lt;!--Preserve types and members in an assembly--&gt;
  &lt;assembly fullname="AssemblyName"&gt;
    &lt;!--Preserve an entire type--&gt;
    &lt;type fullname="AssemblyName.MethodName" preserve="all"/&gt;

    &lt;!--No "preserve" attribute and no members specified means preserve all members--&gt;
    &lt;type fullname="AssemblyName.MethodName"/&gt;

    &lt;!--Preserve all fields on a type--&gt;
    &lt;type fullname="AssemblyName.MethodName" preserve="fields"/&gt;

    &lt;!--Preserve all fields on a type--&gt;
    &lt;type fullname="AssemblyName.MethodName" preserve="methods"/&gt;

    &lt;!--Preserve the type only--&gt;
    &lt;type fullname="AssemblyName.MethodName" preserve="nothing"/&gt;

    &lt;!--Preserving only specific members of a type--&gt;
    &lt;type fullname="AssemblyName.MethodName"&gt;
        
      &lt;!--Fields--&gt;
      &lt;field signature="System.Int32 FieldName" /&gt;

      &lt;!--Preserve a field by name rather than signature--&gt;
      &lt;field name="FieldName" /&gt;
      
      &lt;!--Methods--&gt;
      &lt;method signature="System.Void MethodName()" /&gt;

      &lt;!--Preserve a method with parameters--&gt;
      &lt;method signature="System.Void MethodName(System.Int32,System.String)" /&gt;

      &lt;!--Preserve a method by name rather than signature--&gt;
      &lt;method name="MethodName" /&gt;

      &lt;!--Properties--&gt;

      &lt;!--Preserve a property, it's backing field (if present), 
          getter, and setter methods--&gt;
      &lt;property signature="System.Int32 PropertyName" /&gt;

      &lt;property signature="System.Int32 PropertyName" accessors="all" /&gt;

      &lt;!--Preserve a property, it's backing field (if present), and getter method--&gt;
      &lt;property signature="System.Int32 PropertyName" accessors="get" /&gt;

      &lt;!--Preserve a property, it's backing field (if present), and setter method--&gt;
      &lt;property signature="System.Int32 PropertyName" accessors="set" /&gt;

      &lt;!--Preserve a property by name rather than signature--&gt;
      &lt;property name="PropertyName" /&gt;

      &lt;!--Events--&gt;

      &lt;!--Preserve an event, it's backing field (if present), add, and remove methods--&gt;
      &lt;event signature="System.EventHandler EventName" /&gt;

      &lt;!--Preserve an event by name rather than signature--&gt;
      &lt;event name="EventName" /&gt;

    &lt;/type&gt;
  &lt;/assembly&gt;
&lt;/linker&gt;
</code></pre>

<p>The next example shows how you can declare entire assemblies:</p>

<pre><code class="xml-doc">&lt;!--Preserve an entire assembly--&gt;
  &lt;assembly fullname="AssemblyName" preserve="all"/&gt;

  &lt;!--No "preserve" attribute and no types specified means preserve all--&gt;
  &lt;assembly fullname="AssemblyName"/&gt;

  &lt;!--Fully qualified assembly name--&gt;
  &lt;assembly fullname="AssemblyName, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null"&gt;
    &lt;type fullname="AssemblyName.Foo" preserve="all"/&gt;
  &lt;/assembly&gt;

  &lt;!--Force an assembly to be processed for roots but don’t explicitly preserve anything in particular. Useful when the assembly isn't referenced.--&gt;
  &lt;assembly fullname="AssemblyName" preserve="nothing"/&gt;
</code></pre>

<p>This example shows how to preserve either nested or generic types:</p>

<pre><code class="xml-doc">&lt;!--Examples with generics--&gt;
    &lt;type fullname="AssemblyName.G`1"&gt;

      &lt;!--Preserve a field with generics in the signature--&gt;
      &lt;field signature="System.Collections.Generic.List`1&amp;lt;System.Int32&amp;gt; FieldName" /&gt;

      &lt;field signature="System.Collections.Generic.List`1&amp;lt;T&amp;gt; FieldName" /&gt;

      &lt;!--Preserve a method with generics in the signature--&gt;
      &lt;method signature="System.Void MethodName(System.Collections.Generic.List`1&amp;lt;System.Int32&amp;gt;)" /&gt;

      &lt;!--Preserve an event with generics in the signature--&gt;
      &lt;event signature="System.EventHandler`1&amp;lt;System.EventArgs&amp;gt; EventName" /&gt;

    &lt;/type&gt;

    &lt;!--Preserve a nested type--&gt;
    &lt;type fullname="AssemblyName.H/Nested" preserve="all"/&gt;

    &lt;!--Preserve all fields of a type if the type is used.  If the type isn't used, it will be removed--&gt;
    &lt;type fullname="AssemblyName.I" preserve="fields" required="0"/&gt;

    &lt;!--Preserve all methods of a type if the type is used. If the type isn't used, it will be removed--&gt;
    &lt;type fullname="AssemblyName.J" preserve="methods" required="0"/&gt;

    &lt;!--Preserve all types in a namespace--&gt;
    &lt;type fullname="AssemblyName.SomeNamespace*" /&gt;

    &lt;!--Preserve all types with a common prefix in their name--&gt;
    &lt;type fullname="Prefix*" /&gt;
</code></pre>

<p><a name="AdditionalAssemblyXMLAttributes"></a></p>

<h3>Additional Assembly XML attributes</h3>

<p>The <code>&lt;assembly&gt;</code> element of the link.xml file has three special-purpose attributes that you can enable for more control over the annotations.</p>

<ul>
<li>
<code>ignoreIfMissing</code>: Use this attribute if you need to declare preservations for an assembly that doesn’t exist during all Player builds.</li>
</ul>

<pre><code class="xml-doc">&lt;linker&gt;
  &lt;assembly fullname="Foo" ignoreIfMissing="1"&gt;
    &lt;type name="TypeName"/&gt;
  &lt;/assembly&gt;
&lt;/linker&gt;
</code></pre>

<ul>
<li>
<code>ignoreIfUnreferenced:</code> In some cases, you might want to preserve entities in an assembly only when that assembly is referenced by another assembly. Use this attribute to preserve the entities in an assembly only when at least one type is referenced in an assembly.</li>
</ul>

<pre><code class="xml-doc">&lt;linker&gt;
  &lt;assembly fullname="Bar" ignoreIfUnreferenced="1"&gt;
    &lt;type name="TypeName"/&gt;
  &lt;/assembly&gt;
&lt;/linker&gt;
</code></pre>

<ul>
<li>
<code>windowsruntime:</code> When you define preservations for a Windows Runtime Metadata (.winmd) assembly, you must add the <code>windowsruntime</code> attribute to the <code>&lt;assembly&gt;</code> element in the link.xml file:</li>
</ul>

<pre><code class="xml-doc">&lt;linker&gt;
  &lt;assembly fullname="Windows" windowsruntime="true"&gt;
    &lt;type name="TypeName"/&gt;
 &lt;/assembly&gt;
&lt;/linker&gt;
</code></pre>

<p><a name="DependencyAnnotations"></a></p>

<h2>Dependency annotations</h2>

<p>Dependency annotations define dependencies between various code elements. These annotations are useful for preserving code patterns that the Unity linker can’t statically analyze, such as reflection. These annotations also ensure that these code elements aren’t erroneously preserved when no root element uses them. There are two methods you can use to change how the Unity linker processes code elements:</p>

<ul>
<li>
<a href="#AnnotationAttributes">Annotation attributes</a>: these attributes indicate that the Unity linker should preserve a particular code pattern, such as any type that derives from the annotated type.</li>
<li>
<a href="#AlwaysLinkAssemblyAttribute">AlwaysLinkAssemblyAttribute</a>: use this attribute to indicate that the Unity linker should process an assembly even if it’s not referenced by any other assemblies in your Project.</li>
</ul>

<p><a name="AnnotationAttributes"></a></p>

<h3>Annotation attributes</h3>

<p>The <code>[Preserve]</code> attribute is useful for situations when an API is always needed. Other attributes can be useful for more general preservations. For example, you can preserve all types that implement a particular interface by annotating the interface with the <a href="../ScriptReference/Scripting.RequireImplementorsAttribute.html">RequireImplementorsAttribute</a>.</p>

<p>To annotate specific coding patterns, use one or more of the following attributes:</p>

<ul>
<li>
<a href="../ScriptReference/Scripting.RequireImplementorsAttribute.html">RequireImplementorsAttribute</a>: marks all types that implement this interface as dependencies.</li>
<li>
<a href="../ScriptReference/Scripting.RequireDerivedAttribute.html">RequireDerivedAttribute</a>: marks all types that derive from this type as dependencies.</li>
<li>
<a href="../ScriptReference/Scripting.RequiredInterfaceAttribute.html">RequiredInterfaceAttribute</a>: marks interface implementations on types as dependencies.</li>
<li>
<a href="../ScriptReference/Scripting.RequiredMemberAttribute.html">RequiredMemberAttribute</a>: marks all members of a type as dependencies.</li>
<li>
<a href="../ScriptReference/Scripting.RequireAttributeUsagesAttribute.html">RequireAttributeUsagesAttribute</a>: marks custom attributes as dependencies.</li>
</ul>

<p>You can combine these attributes in various ways to more precisely control how the Unity linker preserves your code.</p>

<p><a name="AlwaysLinkAssemblyAttribute"></a></p>

<h3>AlwaysLinkAssembly 属性</h3>

<p>The <code>[assembly: UnityEngine.Scripting.AlwaysLinkAssembly]</code> attribute forces the Unity linker to search an assembly regardless of whether or not the assembly is referenced by another assembly that is included in the build. You can apply the <a href="../ScriptReference/scripting.AlwaysLinkAssemblyAttribute.html">AlwaysLinkAssembly</a> attribute only to an assembly.</p>

<p>The attribute doesn’t directly preserve code within the assembly. Instead, this attribute instructs the Unity linker to apply the root marking rules to the assembly. If no code elements match the root marking rules for the assembly, the Unity linker still removes the assembly from the build.</p>

<p>Use this attribute on precompiled or package assemblies that contain one or more methods with the <code>[RuntimeInitializeOnLoadMethod]</code> attribute, but which might not contain types used directly or indirectly in any Scenes in a project.</p>

<p>If an assembly defines <code>[assembly: AlwaysLinkAssembly]</code> and is also referenced by another assembly included in the build, the attribute has no effect on the output.</p>
<div id="_content"></div>
<div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="ScriptingRestrictions.html"></a></span><div class="tip">脚本限制</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="unity-linker.html"></a></span><div class="tip">The Unity linker</div>
</div>
</div>
</div>
<div class="footer-wrapper"><div class="footer clear">
<div class="copy">Copyright © 2022 Unity Technologies. Publication 2022.3</div>
<div class="menu">
<a href="https://learn.unity.com/">教程</a><a href="https://answers.unity3d.com">社区答案</a><a href="https://support.unity3d.com/hc/en-us">知识库</a><a href="https://forum.unity3d.com">论坛</a><a href="https://unity3d.com/asset-store">Asset Store</a><a href="https://docs.unity3d.com/Manual/TermsOfUse.html">商标和使用条款</a><a href="https://unity.com/legal">法律条款</a><a href="https://unity.com/legal/privacy-policy">隐私政策</a><a href="https://unity.com/legal/cookie-policy">Cookie</a><a href="https://unity.com/legal/do-not-sell-my-personal-information">不要出售或分享我的个人信息</a><div id="ot-sdk-btn-container"><a id="ot-sdk-btn" class="ot-sdk-show-settings" href="javascript:void(0);">Your Privacy Choices (Cookie Settings)</a></div>
</div>
</div></div>
</div></div></div>
</div>
</body>
</html>
