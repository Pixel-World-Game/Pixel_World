<!DOCTYPE html><html lang="en" class="no-js">
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<script type="text/javascript" src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" charset="UTF-8" data-domain-script="6e91be4c-3145-4ea2-aa64-89d716064836" data-dLayer-ignore="true" data-document-language="true"></script><script type="text/javascript">function OptanonWrapper() {}</script><script>window.dataLayer = window.dataLayer || []; dataLayer.push({ event: 'dataLayer-initialized', user: { user_unity_id: undefined, user_logged_in: 'no' }, environment: { environment_locale: 'en-us', environment_currency: undefined }});</script><script>var offline=(location.href.indexOf('docs.unity3d.com')==-1)?true:false;if(!offline){(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=   'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);  })(window,document,'script','dataLayer','GTM-5V25JL6');}</script><link href="https://fonts.googleapis.com/css?family=Roboto&amp;display=swap" rel="stylesheet">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Unity - Manual: Implement a custom native container</title>
<meta property="og:image" content="https://unity3d.com/files/images/ogimg.jpg">
<meta name="author" content="Unity Technologies">
<link rel="shortcut icon" href="https://unity.com/themes/contrib/unity_base/images/favicons/favicon.ico">
<link rel="icon" type="image/png" href="../StaticFilesManual/images/favicons/favicon.png">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="../StaticFilesManual/images/favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../StaticFilesManual/images/favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="../StaticFilesManual/images/favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../StaticFilesManual/images/favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="../StaticFilesManual/images/favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon-precomposed" href="../StaticFilesManual/images/favicons/apple-touch-icon.png">
<meta name="msapplication-TileColor" content="#222c37">
<meta name="msapplication-TileImage" content="../StaticFilesManual/images/favicons/tileicon-144x144.png">
<script type="text/javascript" src="/StaticFilesConfig/UnityVersionsInfo.js"></script><script type="text/javascript" src="../StaticFilesManual/js/jquery.js?ts=20241003"></script><script type="text/javascript" src="../StaticFilesManual/js/core.js?ts=20241003"></script><script type="text/javascript" src="docdata/toc.js?ts=20241003"></script><script type="text/javascript" src="docdata/global_toc.js?ts=20241003"></script><link rel="stylesheet" type="text/css" href="../StaticFilesManual/css/core.css?ts=20241003">
<link rel="stylesheet" href="../StaticFilesManual/css/prism.css">
<script src="../StaticFilesManual/js/prism.js"></script><script src="/StaticFilesConfig/feedback/feedback.js"></script><script src="../StaticFilesManual/js/jquery.sidebar.min.js"></script><link rel="stylesheet" href="../StaticFilesManual/css/mobileoptimisation.css">
<script src="../StaticFilesManual/js/mobileoptimisation.js"></script>
</head>
<body>
<div id="DocsAnalyticsData" data-area="none" data-pagetype="manual"></div>
<div class="header-wrapper">
<div id="header" class="header"><div class="content">
<div class="spacer"><div class="menu">
<div id="nav-open" for="nav-input"><span></span></div>
<div class="logo"><a href="https://docs.unity3d.com"></a></div>
<div class="search-form"><form action="30_search.html" method="get" class="apisearch">
<input type="text" name="q" placeholder="Search manual..." autosave="Unity Reference" results="5" class="sbox field" id="q"><input type="submit" class="submit">
</form></div>
<ul>
<li><a href="../Manual/index.html" class="selected">Manual</a></li>
<li><a href="../ScriptReference/index.html">Scripting API</a></li>
</ul>
</div></div>
<div class="more">
<div class="filler"></div>
<ul><li><a href="https://unity.com/">unity.com</a></li></ul>
</div>
</div></div>
<div class="toolbar"><div class="content">
<div class="toggle version-number" id="VersionNumber" data-target=".otherversionscontent">
                                Version: <b>2022.3</b><div class="otherversionscontent" id="OtherVersionsContent" style="display: none;">
<ul id="OtherVersionsContentUl"></ul>
<div id="otherVersionsLegend"><ul>
<li>
<div id="supportedColour" class="legendBox"></div>Supported</li>
<li>
<div id="notFoundColour" class="legendBox"></div>Legacy</li>
</ul></div>
</div>
<div id="VersionSwitcherArrow" class="arrow versionSwitcherArrow"></div>
</div>
<div class="lang-switcher"><div class="current toggle" data-target=".lang-list">
<div class="lbl">Language
:                <span class="b">English</span>
</div>
<div class="arrow"></div>
<div class="lang-list" style="display:none;"><ul>
<li><a href="/Manual/job-system-custom-nativecontainer.html">English</a></li>
<li><a href="/cn/current/Manual/job-system-custom-nativecontainer.html">中文</a></li>
<li><a href="/ja/current/Manual/job-system-custom-nativecontainer.html">日本語</a></li>
<li><a href="/kr/current/Manual/job-system-custom-nativecontainer.html">한국어</a></li>
</ul></div>
</div></div>
</div></div>
<div class="mobileLogo"><a href="https://docs.unity3d.com"></a></div>
</div>
<div id="master-wrapper" class="master-wrapper clear">
<div id="sidebar" class="sidebar"><div class="sidebar-wrap"><div class="content"><div class="sidebar-menu"><div class="toc" id="customScrollbar">
<h2>Unity Manual</h2>
<div class="search-form sidebar-search-form"><form action="30_search.html" method="get" class="apisearch">
<input type="text" name="q" placeholder="Search manual..." autosave="Unity Reference" results="5" class="sbox field" id="q"><input type="submit" id="mobileSearchBtn" class="submit" value="Search">
</form></div>
<div class="toggle version-number sidebar-version-switcher" id="VersionNumber" data-target=".otherversionscontent"><form id="otherVersionsContentMobileForm"><div class="ui-field-contain">
<label for="select-native-4">Version: 2022.3</label><select name="select-native-4" id="versionsSelectMobile"><option>Select a different version</option>
<optgroup id="versionsWithThisPageMobile" label="Versions with this page"></optgroup>
<optgroup id="versionsWithoutThisPageMobile" label="Versions without this page"></optgroup></select>
</div></form></div>
<div class="lang-switcher"><div class="current toggle" data-target=".lang-list">
<div class="lbl">Language
:                <span class="b">English</span>
</div>
<div class="arrow"></div>
<div class="lang-list" style="display:none;"><ul>
<li><a href="/Manual/job-system-custom-nativecontainer.html">English</a></li>
<li><a href="/cn/current/Manual/job-system-custom-nativecontainer.html">中文</a></li>
<li><a href="/ja/current/Manual/job-system-custom-nativecontainer.html">日本語</a></li>
<li><a href="/kr/current/Manual/job-system-custom-nativecontainer.html">한국어</a></li>
</ul></div>
</div></div>
</div></div></div></div></div>
<div id="content-wrap" class="content-wrap"><div class="content-block"><div class="content">
<div class="section">
<div class="breadcrumbs clear"><ul>
<li><a href="ScriptingSection.html">Scripting</a></li>
<li><a href="JobSystem.html">Job system </a></li>
<li><a href="JobSystemNativeContainer.html">Thread safe types</a></li>
<li>Implement a custom native container</li>
</ul></div>
<div class="mb20"><div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="JobSystemNativeContainer.html"></a></span><div class="tip">Thread safe types</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="job-system-copy-nativecontainer.html"></a></span><div class="tip">Copying NativeContainer structures</div>
</div>
</div></div>
<div id="_leavefeedback"></div>
<h1>Implement a custom native container</h1>
<!--BeginSwitchLink--><!--EndSwitchLink-->
<div class="clear"></div>

<p>To implement a custom native container, you must annotate your type with the the <a href="../ScriptReference/Unity.Collections.LowLevel.Unsafe.NativeContainerAttribute.html"><code>NativeContainer</code></a> attribute. You should also understand how native containers are integrated with <a href="JobSystemNativeContainer.html#safety-system">the safety system</a>. </p>

<p>There are two major elements to implement: </p>

<ul>
<li>
<strong>Usage tracking:</strong> Allows Unity to keep track of scheduled jobs that use a <code>NativeContainer</code> instance, so that it can detect and prevent potential conflicts, such as two jobs writing to the same native container at the same time.</li>
<li>
<strong>Leak tracking:</strong> Detects when a <code>NativeContainer</code> isn’t disposed of properly. In this situation, a memory leak happens, where the memory allocated to the <code>NativeContainer</code> becomes unavailable for the entire remaining lifetime of the program.</li>
</ul>

<h2>Implement usage tracking</h2>

<p>To access usage tracking in your code, use the <a href="../ScriptReference/Unity.Collections.LowLevel.Unsafe.AtomicSafetyHandle.html"><code>AtomicSafetyHandle</code></a> class. <code>AtomicSafetyHandle</code> holds a reference to the central information that the safety system stores for a given native container, and is the main way that the methods of a <code>NativeContainer</code> interact with the safety system. Because of this, every <code>NativeContainer</code> instance must contain an <code>AtomicSafetyHandle</code> field named <code>m_Safety</code>.</p>

<p>Each <code>AtomicSafetyHandle</code> stores a set of flags that indicate what types of operation can be performed on the native container in the current context. When a job contains a <code>NativeContainer</code> instance, the job system automatically configures the flags in the <code>AtomicSafetyHandle</code> to reflect the way that the native container can be used in that job. </p>

<p>When a job tries to read from a <code>NativeContainer</code> instance, the job system calls the <code>CheckReadAndThrow</code> method before reading, to confirm that the job has read access to the native container. Similarly, when a job tries to write to a native container, the job system calls <code>CheckWriteAndThrow</code> before writing, to check that the job has write access to the native container. Two jobs that have been assigned the same <code>NativeContainer</code> instance have separate <code>AtomicSafetyHandle</code> objects for that native container, so although they both reference the same set of central information, they can each hold separate flags that indicate what read and write access each job has to the native container.</p>

<h2>Implement leak tracking</h2>

<p>Unity’s native code primarily implements leak tracking. It uses the <a href="../ScriptReference/Unity.Collections.LowLevel.Unsafe.UnsafeUtility.MallocTracked.html"><code>UnsafeUtility.MallocTracked</code></a> method to allocate the memory needed to store <code>NativeContainer</code> data, and then uses <a href="../ScriptReference/Unity.Collections.LowLevel.Unsafe.UnsafeUtility.FreeTracked.html"><code>UnsafeUtility.FreeTracked</code></a> to dispose of it.</p>

<p>In earlier versions of Unity the <a href="../ScriptReference/Unity.Collections.LowLevel.Unsafe.DisposeSentinel.html"><code>DisposeSentinel</code></a> class provides leak tracking. Unity reports a memory leak when the <a href="performance-garbage-collector.html">garbage collector</a> collects the <code>DisposeSentinel</code> object. To create a <code>DisposeSentinel</code>, use the <code>Create</code> method, which also initializes the <code>AtomicSafetyHandle</code> at the same time. When you use this method, you don’t need to initialize the <code>AtomicSafetyHandle</code>. When the <code>NativeContainer</code> is disposed of, the <code>Dispose</code> method disposes of both the <code>DisposeSentinel</code> and the <code>AtomicSafetyHandle</code> in a single call.</p>

<p>To identify where the leaked <code>NativeContainer</code> was created, you can capture the stack trace of where the memory was originally allocated. To do this, use the <a href="../ScriptReference/Unity.Collections.NativeLeakDetection.Mode.html"><code>NativeLeakDetection.Mode</code></a> property. You can also access this property in the Editor. To do this, go to <strong>Preferences</strong> &gt; <strong>Jobs</strong> &gt; <strong>Leak Detection Level</strong> and choose the leak detection level you need.</p>

<h2>Nested native containers</h2>

<p>The safety system doesn’t support nested native containers in jobs, because the job system can’t correctly configure the <code>AtomicSafetyHandle</code> for each individual <code>NativeContainer</code> inside the larger <code>NativeContainer</code> instance.</p>

<p>To prevent scheduling jobs that use nested native containers, use <code>SetNestedContainer</code>, which flags a <code>NativeContainer</code> as nested when they contain other <code>NativeContainer</code> instances. </p>

<h2>Safety IDs and error messages</h2>

<p>The safety system provides error messages that indicate when your code doesn’t adhere to safety constraints. To help make the error messages clearer, you can register a <code>NativeContainer</code> object’s name with the safety system. </p>

<p>To register a name, use <a href="../ScriptReference/Unity.Collections.LowLevel.Unsafe.AtomicSafetyHandle.NewStaticSafetyId.html"><code>NewStaticSafetyId</code></a>, which returns a safety ID that you can pass to <a href="../ScriptReference/Unity.Collections.LowLevel.Unsafe.AtomicSafetyHandle.SetStaticSafetyIdl.html"><code>SetStaticSafetyId</code></a>. Once you create a safety ID, you can reuse it for all instances of the <code>NativeContainer</code>, so a common pattern is to store it in a static member of the container class.</p>

<p>You can also override the error messages for specific safety constraint violations with <a href="../ScriptReference/Unity.Collections.LowLevel.Unsafe.AtomicSafetyHandle.SetCustomErrorMessage.html"><code>SetCustomErrorMessage</code></a>.</p>

<h2>Additional resources</h2>

<ul>
<li><a href="job-system-copy-nativecontainer.html">Copying NativeContainer structures</a></li>
<li><a href="job-system-custom-nativecontainer-example.html">Custom NativeContainer example</a></li>
</ul>
<div id="_content"></div>
<div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="JobSystemNativeContainer.html"></a></span><div class="tip">Thread safe types</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="job-system-copy-nativecontainer.html"></a></span><div class="tip">Copying NativeContainer structures</div>
</div>
</div>
</div>
<div class="footer-wrapper"><div class="footer clear">
<div class="copy">Copyright © 2024 Unity Technologies. Publication Date: 2024-10-03.</div>
<div class="menu">
<a href="https://learn.unity.com/">Tutorials</a><a href="https://answers.unity3d.com">Community Answers</a><a href="https://support.unity3d.com/hc/en-us">Knowledge Base</a><a href="https://forum.unity3d.com">Forums</a><a href="https://unity3d.com/asset-store">Asset Store</a><a href="https://docs.unity3d.com/Manual/TermsOfUse.html">Terms of use</a><a href="https://unity.com/legal">Legal</a><a href="https://unity.com/legal/privacy-policy">Privacy Policy</a><a href="https://unity.com/legal/cookie-policy">Cookies</a><a href="https://unity.com/legal/do-not-sell-my-personal-information">Do Not Sell or Share My Personal Information</a><div id="ot-sdk-btn-container"><a id="ot-sdk-btn" class="ot-sdk-show-settings" href="javascript:void(0);">Your Privacy Choices (Cookie Settings)</a></div>
</div>
</div></div>
</div></div></div>
</div>
</body>
</html>
